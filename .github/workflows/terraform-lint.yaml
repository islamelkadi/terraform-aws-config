name: Terraform Lint and Format Check

on:
  pull_request:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-lint.yml'
  push:
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-lint.yml'

jobs:
  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.3

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Comment on PR (Format Issues)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Terraform Format Check Failed**\n\nPlease run `terraform fmt -recursive` to format your Terraform code.'
            })

      - name: Fail if format check failed
        if: steps.fmt.outcome == 'failure'
        run: exit 1

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint
        id: tflint
        run: tflint --recursive --format compact
        continue-on-error: true

      - name: Comment on PR (TFLint Issues)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **TFLint Check Failed**\n\nPlease review the TFLint errors in the workflow logs and fix them.'
            })

      - name: Fail if TFLint failed
        if: steps.tflint.outcome == 'failure'
        run: exit 1

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.3

      - name: Find Terraform directories
        id: find-dirs
        run: |
          # Find all directories containing .tf files (excluding .terraform directories)
          dirs=$(find . -type f -name "*.tf" ! -path "*/.terraform/*" -exec dirname {} \; | sort -u)
          echo "Found directories: $dirs"
          echo "dirs<<EOF" >> $GITHUB_OUTPUT
          echo "$dirs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Terraform Init and Validate
        id: validate
        run: |
          failed=0
          while IFS= read -r dir; do
            if [ -n "$dir" ]; then
              echo "Validating $dir..."
              cd "$GITHUB_WORKSPACE/$dir"
              if terraform init -backend=false > /dev/null 2>&1; then
                if ! terraform validate; then
                  echo "❌ Validation failed in $dir"
                  failed=1
                fi
              else
                echo "⚠️  Skipping $dir (init failed - may not be a root module)"
              fi
            fi
          done <<< "${{ steps.find-dirs.outputs.dirs }}"
          exit $failed
        continue-on-error: true

      - name: Comment on PR (Validation Issues)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Terraform Validate Failed**\n\nPlease review the validation errors in the workflow logs and fix them.'
            })

      - name: Fail if validation failed
        if: steps.validate.outcome == 'failure'
        run: exit 1
